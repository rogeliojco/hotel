<% layout('layout/layout.ejs') %>

<link rel="stylesheet" href="/css/perfil.css">

<div class="perfil-hero text-white text-center py-5">
  <h1 class="text-uppercase" style="text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);">
    Bienvenida, <%= user.name.toLowerCase() %>
  </h1>
</div>

<div class="container perfil-container mt-4">
  <!-- Tarjeta de usuario -->
  <div class="row justify-content-center mb-4">
    <div class="col-lg-8 col-md-10">
      <div class="bg-white rounded shadow p-3 d-flex flex-wrap align-items-center justify-content-between perfil-card">
        <div class="d-flex align-items-center">
          <img src="<%= user.avatarUrl || '/images/avatar-generico.png' %>" alt="Avatar" class="perfil-avatar-img me-3">
          <div>
            <h5 class="mb-1 text-uppercase"><%= user.name %> 
              <span class="badge bg-warning text-dark ms-2">
                <i class="bi bi-star-fill"></i> Miembro
              </span>
            </h5>
            <p class="mb-0 text-muted"><%= user.email %></p>
            <small class="text-muted">
              <i class="bi bi-clock"></i> 
              √öltimo acceso: <%= new Date().toLocaleTimeString('es-MX') %>
            </small>
          </div>
        </div>
        <div class="d-flex gap-2 mt-3 mt-md-0">
          <a href="/hoteles" class="btn btn-primary">
            <i class="bi bi-calendar-check-fill"></i> Reservar ahora
          </a>
          <a href="/editar-perfil" class="btn btn-outline-dark">
            <i class="bi bi-pencil-fill"></i> Editar perfil
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Contadores -->
  <div class="row text-center mb-4">
    <div class="col-md-3 mb-3">
      <div class="card p-3 shadow-sm">
        <h2><%= reservas?.length || 0 %></h2>
        <p class="text-muted mb-0">Reservas</p>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card p-3 shadow-sm">
        <h2><%= resenas?.length || 0 %></h2>
        <p class="text-muted mb-0">Rese√±as</p>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card p-3 shadow-sm">
        <h2><%= facturas?.length || 0 %></h2>
        <p class="text-muted mb-0">Facturas</p>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card p-3 shadow-sm">
        <h2><%= moment(user.createdAt).format('MMMM [de] YYYY') %></h2>
        <p class="text-muted mb-0">Miembro desde</p>
      </div>
    </div>
  </div>

  <!-- Reservaciones -->
  <div class="card-section mb-5">
    <h4 class="section-title">Mis Reservaciones</h4>
    <% if (reservas.length > 0) { %>
      <% reservas.forEach(r => { const hotel = r.hotel; %>
        <div class="hotel-reservation-card d-flex flex-column flex-md-row align-items-center gap-3 mb-3" id="reserva-<%= r._id %>">
          <img src="<%= hotel?.urlImagen || '/images/hotel-default.jpg' %>" class="img-thumbnail" style="width: 120px; height: 80px; object-fit: cover;" alt="Imagen hotel">
          <div class="flex-grow-1">
            <p class="mb-1"><strong>Hotel:</strong> <%= hotel?.nombre || 'No disponible' %></p>
            <p class="mb-1"><strong>Ciudad:</strong> <%= hotel?.estado || 'No disponible' %></p>
            <p class="mb-1"><strong>Fechas:</strong> <%= new Date(r.fechaInicio).toLocaleDateString('es-MX') %> - <%= new Date(r.fechaFin).toLocaleDateString('es-MX') %></p>
            <span class="badge <%= r.estado === 'cancelada' ? 'bg-danger' : 'bg-success' %>">
              <%= r.estado.charAt(0).toUpperCase() + r.estado.slice(1) %>
            </span>
          </div>
          <div class="d-flex flex-column gap-2">
            <a href="/reserva/<%= r._id %>" class="btn btn-sm btn-outline-primary">Ver detalles</a>
            <% if (r.estado === 'cancelada') { %>
              <form action="/reserva/<%= r._id %>/eliminar" method="POST" onsubmit="return confirm('¬øEst√°s segura de eliminar esta reserva cancelada?');">
                <button type="submit" class="btn btn-sm btn-danger">
                  <i class="bi bi-trash"></i> Eliminar
                </button>
              </form>
            <% } else { %>
              <a href="/reserva/<%= r._id %>/factura" class="btn btn-sm btn-success">
                <i class="fas fa-file-invoice-dollar"></i> Descargar Factura
              </a>
            <% } %>
          </div>
        </div>
      <% }) %>
    <% } else { %>
      <p class="text-muted">No tienes reservaciones registradas.</p>
    <% } %>
  </div>
</div>
<div class="row">
  <!-- Rese√±as y Calendario lado a lado -->
  <div class="row">
    <!-- Rese√±as -->
<div class="col-md-6">
  <div class="resenas-box p-4 rounded shadow-sm mb-5">
    <h4 class="mb-3">Mis Rese√±as</h4>

    <!-- Formulario nueva rese√±a -->
    <form id="formNuevaResena" class="mb-4">
      <div class="mb-2">
        <input type="text" name="titulo" placeholder="T√≠tulo" class="form-control" required>
      </div>
      <div class="mb-2">
        <textarea name="comentario" placeholder="Escribe tu rese√±a..." class="form-control" required></textarea>
      </div>
      <div class="mb-2">
        <label>Puntuaci√≥n:</label>
        <select name="puntuacion" class="form-select" required>
          <option value="5">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option>
          <option value="4">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option>
          <option value="3">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option>
          <option value="2">‚≠êÔ∏è‚≠êÔ∏è</option>
          <option value="1">‚≠êÔ∏è</option>
        </select>
      </div>
      <input type="hidden" name="reservaId" value="<%= reservas[0]?._id || '' %>">
      <button class="btn btn-outline-primary" type="submit">Agregar Rese√±a</button>
    </form>

    <!-- Filtro de ordenamiento -->
    <div class="mb-3">
      <label for="ordenarPor">Ordenar por:</label>
      <select id="ordenarPor" class="form-select" onchange="filtrarOrdenar()">
        <option value="recientes">M√°s recientes</option>
        <option value="antiguas">M√°s antiguas</option>
        <option value="puntuacion-alta">Puntuaci√≥n alta</option>
        <option value="puntuacion-baja">Puntuaci√≥n baja</option>
      </select>
    </div>

    <!-- Lista de rese√±as -->
    <div id="contenedorResenas">
      <% resenas.forEach(function(rese√±a) { %>
        <div class="card mb-3 p-3 border-left-purple review-item" data-id="<%= rese√±a._id %>">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5><%= rese√±a.titulo %></h5>
              <div class="rating mb-1">
                <% for (let i = 1; i <= 5; i++) { %>
                  <i class="bi <%= rese√±a.puntuacion >= i ? 'bi-star-fill text-warning' : 'bi-star' %>"></i>
                <% } %>
              </div>
              <p><%= rese√±a.comentario %></p>
              <small class="text-muted">Publicado el <%= new Date(rese√±a.fecha).toLocaleDateString('es-MX') %></small>
            </div>
            <div class="d-flex flex-column align-items-end">
              <button class="btn btn-sm btn-outline-secondary mb-2" onclick="editarResena('<%= rese√±a._id %>')">‚úèÔ∏è</button>
              <button class="btn btn-sm btn-outline-danger btn-eliminar-resena">üóëÔ∏è</button>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  </div>
</div>


<script>
  function filtrarOrdenar() {
    const criterio = document.getElementById('ordenarPor').value;
    window.location.href = `/perfil?orden=${criterio}`;
  }

  function editarResena(id) {
    alert('Funcionalidad para editar rese√±a a√∫n no implementada.');
    // Aqu√≠ puedes abrir un modal o redirigir a /editarResena/:id
  }
</script>
    <!-- Calendario -->
     <!-- Columna derecha: Calendario + Notificaciones -->
  <div class="col-md-6">
    <!-- Calendario -->
    <div class="card-section mb-4">
      <h4 class="section-title">Calendario</h4>
      <div class="calendar-grid text-center">
        <% for (let i = 1; i <= 30; i++) { %>
          <span class="<%= [10, 20, 21, 22, 23].includes(i) ? 'active-date' : '' %>"><%= i %></span>
        <% } %>
      </div>
      <p class="text-muted text-center mt-2">Pr√≥ximo viaje: 20‚Äì23 jun</p>
    </div>

    <!-- Historial de actividad -->
    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
      <div class="card-header bg-primary text-white fw-bold">
        <i class="bi bi-clock-history me-2"></i> Historial de Actividad
      </div>
      <div class="list-group list-group-flush">
        <% notificaciones.forEach(n => { 
          let tipoClase = 'text-muted';
          let icono = 'bi-info-circle';
          if (n.tipo === 'reserva') { tipoClase = 'text-success'; icono = 'bi-check-circle-fill'; }
          else if (n.tipo === 'cancelacion') { tipoClase = 'text-danger'; icono = 'bi-x-circle-fill'; }
          else if (n.tipo === 'resena') { tipoClase = 'text-warning'; icono = 'bi-star-fill'; }
          else if (n.tipo === 'avatar') { tipoClase = 'text-primary'; icono = 'bi-person-circle'; }
          else if (n.tipo === 'perfil' || n.tipo === 'password') { tipoClase = 'text-info'; icono = 'bi-gear-fill'; }
        %>
          <div class="list-group-item d-flex justify-content-between align-items-start flex-column flex-md-row gap-2">
            <div class="d-flex align-items-start">
              <i class="bi <%= icono %> fs-5 me-3 <%= tipoClase %>"></i>
              <div>
                <p class="mb-1 fw-semibold <%= tipoClase %>"><%= n.mensaje %></p>
                <small class="text-muted"><%= moment(n.fecha).format('D/M/YYYY, h:mm:ss a') %></small>
              </div>
            </div>
            <form action="/notificaciones/<%= n._id %>/eliminar" method="POST">
              <button type="submit" class="btn btn-outline-danger btn-sm rounded-circle">
                <i class="bi bi-x-lg"></i>
              </button>
            </form>
          </div>
        <% }) %>
      </div>
      <% if (notificaciones.length > 0) { %>
        <div class="card-footer text-end">
          <form action="/notificaciones/eliminar-todas" method="POST">
            <button class="btn btn-outline-secondary btn-sm rounded-pill">
              <i class="bi bi-trash"></i> Eliminar todas
            </button>
          </form>
        </div>
      <% } %>
    </div>
  </div>
</div>




<!-- Recomendaciones -->
<div class="card-section">
  <h5 class="section-title">Recomendaciones</h5>

  <div id="carouselRecomendaciones" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="5000">
    <div class="carousel-inner">

      <div class="carousel-item active">
        <div class="card shadow-lg border-0 p-4 d-flex flex-column flex-md-row gap-3 align-items-center bg-light rounded-4 position-relative">
          <!-- Bot√≥n favorito -->
          <button class="btn btn-fav position-absolute top-0 end-0 m-2" onclick="toggleFavorito('rec1', this)">
            <i class="bi bi-heart"></i>
          </button>
          <img src="/images/hotel1.jpg" class="img-fluid rounded" alt="Hotel Para√≠so del Mar" style="width: 120px; height: 90px; object-fit: cover;">
          <div class="text-start">
            <h6 class="fw-bold mb-1">Hotel Para√≠so del Mar</h6>
            <p class="text-muted small mb-0">Disfruta de un ambiente tropical frente al oc√©ano.</p>
          </div>
        </div>
      </div>

      <div class="carousel-item">
        <div class="card shadow-lg border-0 p-4 d-flex flex-column flex-md-row gap-3 align-items-center bg-light rounded-4 position-relative">
          <button class="btn btn-fav position-absolute top-0 end-0 m-2" onclick="toggleFavorito('rec2', this)">
            <i class="bi bi-heart"></i>
          </button>
          <img src="/images/hotel2.jpg" class="img-fluid rounded" alt="Sierra Lodge & Spa" style="width: 120px; height: 90px; object-fit: cover;">
          <div class="text-start">
            <h6 class="fw-bold mb-1">Sierra Lodge & Spa</h6>
            <p class="text-muted small mb-0">Rel√°jate en las monta√±as con nuestro exclusivo spa.</p>
          </div>
        </div>
      </div>

      <div class="carousel-item">
        <div class="card shadow-lg border-0 p-4 d-flex flex-column flex-md-row gap-3 align-items-center bg-light rounded-4 position-relative">
          <button class="btn btn-fav position-absolute top-0 end-0 m-2" onclick="toggleFavorito('rec3', this)">
            <i class="bi bi-heart"></i>
          </button>
          <img src="/images/hotel3.jpg" class="img-fluid rounded" alt="Ciudadela Business Hotel" style="width: 120px; height: 90px; object-fit: cover;">
          <div class="text-start">
            <h6 class="fw-bold mb-1">Ciudadela Business Hotel</h6>
            <p class="text-muted small mb-0">Perfecto para viajes de negocios con todas las comodidades.</p>
          </div>
        </div>
      </div>

    <button class="carousel-control-prev" type="button" data-bs-target="#carouselRecomendaciones" data-bs-slide="prev">
      <span class="carousel-control-prev-icon bg-dark rounded-circle"></span>
      <span class="visually-hidden">Anterior</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselRecomendaciones" data-bs-slide="next">
      <span class="carousel-control-next-icon bg-dark rounded-circle"></span>
      <span class="visually-hidden">Siguiente</span>
    </button>
  </div>
</div>




<script>
  const ocultarReserva = (id) => {
    const card = document.getElementById(`reserva-${id}`);
    if (card) {
      card.remove();
      const ocultas = JSON.parse(localStorage.getItem('reservasOcultas') || '[]');
      if (!ocultas.includes(id)) {
        ocultas.push(id);
        localStorage.setItem('reservasOcultas', JSON.stringify(ocultas));
      }
    }
  };

  // Al cargar, ocultar las reservaciones que est√©n en localStorage
  document.addEventListener('DOMContentLoaded', () => {
    const ocultas = JSON.parse(localStorage.getItem('reservasOcultas') || '[]');
    ocultas.forEach(id => {
      const card = document.getElementById(`reserva-${id}`);
      if (card) card.style.display = 'none';
    });
  });
</script>


<!-- AJAX rese√±as -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('formNuevaResena');
  const contenedor = document.getElementById('contenedorResenas');

  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    const formData = new FormData(form);
    const datos = Object.fromEntries(formData.entries());

    try {
      const res = await fetch('/resenas/nueva', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });

      const result = await res.json();

      if (result.success) {
        const nueva = document.createElement('div');
        nueva.classList.add('review-item', 'mb-2', 'fade-in');
        nueva.innerHTML = `
          <i class="bi bi-star-fill review-icon"></i>
          <div>
            <strong>${result.resena.titulo}</strong><br>
            <span>${result.resena.comentario}</span>
          </div>`;
        contenedor.prepend(nueva);
        form.reset();
      } else {
        alert(result.message || 'Error al enviar rese√±a');
      }

    } catch (err) {
      console.error('Error:', err);
      alert('Hubo un problema al enviar la rese√±a.');
    }
  });
});
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('formNuevaResena');
    const contenedor = document.getElementById('contenedorResenas');

    // C√≥digo para enviar rese√±as (ya lo tienes aqu√≠)

    // ‚úÖ Nuevo c√≥digo para eliminar rese√±as
    contenedor.addEventListener('click', async function (e) {
      if (e.target.closest('.btn-eliminar-resena')) {
        const item = e.target.closest('.review-item');
        const id = item.getAttribute('data-id');

        if (confirm('¬øEst√°s segura de que deseas eliminar esta rese√±a?')) {
          try {
            const res = await fetch(`/resenas/eliminar/${id}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });

            const result = await res.json();

            if (result.success) {
              item.remove();
            } else {
              alert(result.message || 'No se pudo eliminar la rese√±a.');
            }
          } catch (err) {
            console.error('Error:', err);
            alert('Hubo un problema al eliminar la rese√±a.');
          }
        }
      }
    });
  });
</script>
<script>
  function toggleFavorito(id, btn) {
    let favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]');
    const icono = btn.querySelector('i');

    if (favoritos.includes(id)) {
      favoritos = favoritos.filter(fid => fid !== id);
      btn.classList.remove('active');
      icono.className = 'bi bi-heart';
    } else {
      favoritos.push(id);
      btn.classList.add('active');
      icono.className = 'bi bi-heart-fill';
    }

    localStorage.setItem('favoritos', JSON.stringify(favoritos));
  }

  // Marcar favoritos guardados al cargar
  document.addEventListener('DOMContentLoaded', () => {
    const favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]');
    favoritos.forEach(id => {
      const btn = document.querySelector(`.btn-fav[onclick*="${id}"]`);
      if (btn) {
        btn.classList.add('active');
        btn.querySelector('i').className = 'bi bi-heart-fill';
      }
    });
  });
</script>

